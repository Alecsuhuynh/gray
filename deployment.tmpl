---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: $DEPLOYMENT_NAME
  namespace: $NAMESPACE
  labels:
   app: $DEPLOYMENT_NAME
  annotations: 
    kubernetes.io/change-cause: $CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA
spec:
  replicas: $DEPLOYMENT_REPLICAS
  selector:
    matchLabels:
      app: $DEPLOYMENT_NAME
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  minReadySeconds: 5
  template:
    metadata:
      labels:
        app: $DEPLOYMENT_NAME
    spec:
      containers:
      - name: $DEPLOYMENT_NAME
        image: $REGISTRY_PROJECT/$DEPLOYMENT_NAME:$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA
        ports:
        - containerPort: $CONTAINER_PORT
          protocol: $PROTOCOL_PORT
#        resources:
#          limits: 
#            cpu: $LIMIT_CPU
#            memory: $LIMIT_MEMORY  
#          requests:
#            cpu: $REQUEST_CPU
#            memory: $REQUEST_MEMORY
      imagePullSecrets:
      - name: regcred
---
apiVersion: v1
kind: Service
metadata:
  name: $DEPLOYMENT_NAME
  namespace: $NAMESPACE
spec:
  ports:
  - name: app
    port: $CONTAINER_PORT
  selector:
    app: $DEPLOYMENT_NAME
  clusterIP: None
---
kind: Ingress
apiVersion: extensions/v1beta1
metadata:
  name: ingress-$DEPLOYMENT_NAME
  namespace: $NAMESPACE
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
spec:
#  tls:
#    - hosts:
#        - $INGRESS_HOST
#      secretName: $TLS_SECRET
  rules:
    - host: $INGRESS_HOST
      http:
        paths:
          - path: /$INGRESS_PATH
            pathType: Prefix
            backend:
              serviceName: $DEPLOYMENT_NAME
              servicePort: $CONTAINER_PORT
